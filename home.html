<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poortjie Services</title>
    <meta name="author" content="Musa Mgijima">
    <meta name="description" content="Poortjie Services connects you with local Kasi services: From school transport and tow trucks to professional designers and web developers.">
    <meta name="keywords" content="Poortjie, Kasi services, transport, school transport, graphic design, web development, South Africa">
    <meta name="copyright" content="Â© 2026 Poortjie Services. All rights reserved.">
    <meta name="robots" content="index,follow">
    <meta name="theme-color" content="#22c55e">

    <link rel="icon" href="favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">

<div class="fixed top-5 right-5 z-50" id="user-controls">
    <!-- Theme Toggle removed from here and moved to hamburger menu -->
    
    <div id="hamburger-menu" class="relative">
        <button id="hamburger-btn" class="p-3 rounded-full bg-green-600 text-white shadow-lg hover:bg-green-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <div id="menu-items" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5">
            <button id="menu-theme-toggle" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-3">
                <span id="menu-theme-icon">ðŸŒ“</span> Mode
            </button>
            <a id="admin-link" href="admin/admin.html" onclick="window.top.location.replace('admin/admin.html'); return false;" class="hidden block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700">Admin</a>
            <a href="services/business-form.html" onclick="window.top.location.replace('services/business-form.html'); return false;" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700">Add Your Business</a>
            <div id="auth-divider" class="hidden border-t border-gray-100 dark:border-slate-700 my-1"></div>
            <button id="logout-btn" class="hidden w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700">Logout</button>
        </div>
    </div>
</div>

<header class="max-w-6xl mx-auto pt-24 pb-16 px-6 text-center">
    <div class="mb-4 flex justify-center">
        <div class="bg-green-500 text-white px-4 py-1 rounded-full text-sm font-bold tracking-widest uppercase">services</div>
    </div>
    <h1 class="text-6xl font-extrabold mb-4 tracking-tight">Poortjie</h1>
    <p class="text-xl opacity-80 max-w-2xl mx-auto leading-relaxed">
        The digital heartbeat of the township. Access reliable transport, professional designers, and expert developersâ€”all in one place.
    </p>

    <div class="flex flex-wrap justify-center gap-4 mt-8">
        <a href="#services" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md">Explore Services</a>
        <a href="services/taxi%20rank.html" onclick="window.top.location.replace('services/taxi rank.html'); return false;" class="px-8 py-3 border-2 border-green-600 text-green-600 dark:text-green-400 font-bold rounded-lg hover:bg-green-600 hover:text-white transition">Taxi Rank Info</a>
    </div>
</header>

<main class="max-w-6xl mx-auto px-6 pb-24" id="services">

    <div class="mb-12 flex flex-col md:flex-row gap-4">
        <div class="relative flex-grow">
            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <label for="search-bar"></label><input type="text" id="search-bar" placeholder="Search categories..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <label for="sort-list"></label><select id="sort-list" class="px-4 py-3 rounded-lg border border-gray-300 bg-white dark:bg-slate-800 dark:border-slate-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="asc">Name (A-Z)</option>
            <option value="desc">Name (Z-A)</option>
        </select>
    </div>

    <div id="services-grid" class="grid md:grid-cols-3 gap-8">
    </div>

    <section class="mt-24 card p-10 rounded-3xl bg-gradient-to-br from-green-50 to-transparent dark:from-green-900/10">
        <div class="max-w-3xl">
            <h2 class="text-3xl font-bold mb-4">Built for the community.</h2>
            <p class="text-lg opacity-80 mb-6">
                Poortjie Services uses cost-effective, modern architecture (like pure HTML, CSS, and JavaScript) to ensure that even the smallest local business has a high-performance home online.
            </p>
            <div class="flex gap-4">
                <span class="text-[10px] font-bold px-2 py-1 border border-green-500/30 rounded text-green-500 uppercase tracking-widest">Mobile First</span>
                <span class="text-[10px] font-bold px-2 py-1 border border-green-500/30 rounded text-green-500 uppercase tracking-widest">Kasi Focused</span>
            </div>
        </div>
    </section>

</main>

<footer class="text-center py-12 border-t border-gray-100 dark:border-slate-800 opacity-50 text-xs">
    &copy; 2026 <a href="index.html" onclick="window.top.location.replace('index.html'); return false;" class="hover:underline">Poortjie Services</a>. Empowering poortjie economies.
</footer>

<script src="scripts/theme.js"></script>
<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script src="scripts/local-db.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="scripts/firebase.js"></script>

<script>
    let allServices = [];

    function renderCards(servicesData) {
        if (!servicesData) return;
        const grid = document.getElementById('services-grid');
        grid.innerHTML = servicesData.map(service => `
            <section class="space-y-6">
                <h2 class="text-2xl font-bold flex items-center gap-3">
                    <span class="w-8 h-1 bg-green-500"></span> ${service.category}
                </h2>
                <div class="card flex flex-col p-6 rounded-2xl border-l-4 border-l-green-500">
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold mb-2">${service.title}</h3>
                        <p class="text-sm opacity-70 mb-4">${service.description}</p>
                        <ul class="space-y-2 text-sm font-medium">
                            ${service.list.map(item => `<li class="flex items-center gap-2">${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mt-6 flex flex-col gap-2">
                        <a href="${service.url}" onclick="window.top.location.replace('${service.url}'); return false;" class="block text-center py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">${service.btnText}</a>
                        ${service.extraBtn ? `<a href="${service.extraBtn.url}" onclick="window.top.location.replace('${service.extraBtn.url}'); return false;" class="block text-center py-2 border-2 border-green-600 text-green-600 dark:text-green-400 rounded-lg font-bold hover:bg-green-600 hover:text-white transition">${service.extraBtn.text}</a>` : ''}
                    </div>
                </div>
            </section>
        `).join('');
    }

    function filterAndSort() {
        const searchTerm = document.getElementById('search-bar').value.toLowerCase();
        const sortValue = document.getElementById('sort-list').value;

        let filtered = allServices.filter(service => 
            service.category.toLowerCase().includes(searchTerm) || 
            service.title.toLowerCase().includes(searchTerm) ||
            service.description.toLowerCase().includes(searchTerm)
        );

        if (sortValue === 'asc') {
            filtered.sort((a, b) => a.category.localeCompare(b.category));
        } else if (sortValue === 'desc') {
            filtered.sort((a, b) => b.category.localeCompare(a.category));
        }

        renderCards(filtered);
    }

    function fetchAndRenderServices() {
        // 1. Try to load from cache first for instant UI
        try {
            const cachedServices = sessionStorage.getItem('servicesCache');
            if (cachedServices) {
                allServices = JSON.parse(cachedServices);
                filterAndSort();
            }
        } catch (e) {
            console.error("Could not read from sessionStorage:", e);
        }

        // 2. Fetch from Firestore to get the latest data
        const servicesDocRef = firebase.firestore().collection('poortjie').doc('services');
        servicesDocRef.get().then((doc) => {
            if (doc.exists) {
                const homeScreenData = doc.data().homeScreen;
                if (homeScreenData && typeof homeScreenData === 'object') {
                    allServices = Object.keys(homeScreenData)
                        .filter(key => homeScreenData[key].status !== 'inactive')
                        .map(key => {
                        const service = homeScreenData[key];
                        return {
                            category: key,
                            title: service.subtitle,
                            description: service.description,
                            list: service.listing || [],
                            url: `services/${key.toLowerCase()}.html`,
                            target: '_top',
                            btnText: `Explore ${key}`
                        };
                    });
                    
                    filterAndSort();
                    try {
                        sessionStorage.setItem('servicesCache', JSON.stringify(allServices));
                    } catch (e) {
                        console.error("Could not write to sessionStorage:", e);
                    }

                } else {
                    console.log("'homeScreen' data not found or is not an object.");
                    allServices = [];
                    filterAndSort();
                }
            } else {
                console.log("No 'services' document found!");
                allServices = [];
                filterAndSort();
            }
        }).catch((error) => {
            console.error("Error fetching services:", error);
            // Don't clear the grid if there's a network error, stale cache is better than nothing
        });
    }

    // RUN ON LOAD
    window.onload = () => {
        fetchAndRenderServices();

        document.getElementById('search-bar').addEventListener('input', filterAndSort);
        document.getElementById('sort-list').addEventListener('change', filterAndSort);

        // AUTH & UI SCRIPTS
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const menuItems = document.getElementById('menu-items');
        const logoutBtn = document.getElementById('logout-btn');
        const adminLink = document.getElementById('admin-link');
        const authDivider = document.getElementById('auth-divider');

        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            menuItems.classList.toggle('hidden');
        });

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                logoutBtn.classList.remove('hidden');
                authDivider.classList.remove('hidden');
                firebase.firestore().collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists && doc.data().roles?.digilayn?.isSuperUser) {
                        adminLink.classList.remove('hidden');
                    }
                });
            } else {
                logoutBtn.classList.add('hidden');
                authDivider.classList.add('hidden');
                adminLink.classList.add('hidden');
            }
        });

        window.onclick = (e) => {
            if (hamburgerMenu && !hamburgerMenu.contains(e.target)) menuItems.classList.add('hidden');
        };

        // THEME TOGGLE LOGIC
        const menuThemeToggle = document.getElementById('menu-theme-toggle');
        const menuThemeIcon = document.getElementById('menu-theme-icon');
        
        if (menuThemeToggle) {
            menuThemeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }

        logoutBtn.onclick = () => firebase.auth().signOut();
    };

    console.log("website developed by Musa Mgijima");
</script>
</body>
</html>
