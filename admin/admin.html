<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Poortjie Services</title>
    <meta name="robots" content="noindex, nofollow"> <!-- Prevents search engines from indexing this page -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" href="../favicon/favicon.ico">
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">

<div id="admin-content" class="hidden">
    <header class="max-w-6xl mx-auto pt-24 pb-16 px-6">
        <h1 class="text-4xl font-extrabold mb-4 tracking-tight">Admin Dashboard</h1>
        <p class="text-xl opacity-80">Welcome, Super User!</p>
    </header>

    <main class="max-w-6xl mx-auto px-6 pb-24">
        <div class="card p-8 rounded-2xl">
            <h2 class="text-2xl font-bold mb-6">Business Applications</h2>
            <div id="applications-list" class="space-y-4">
            </div>
        </div>
    </main>
</div>

<script src="../scripts/theme.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>

<script>
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            const userRef = db.collection('users').doc(user.uid);
            userRef.get().then((doc) => {
                if (doc.exists && doc.data().roles?.digilayn?.isSuperUser === true) {
                    document.getElementById('admin-content').classList.remove('hidden');
                    loadApplications();
                } else {
                    window.location.replace('../index.html');
                }
            }).catch((error) => {
                console.error("Error getting user data:", error);
                alert('An error occurred while verifying your permissions.');
                window.location.replace('../index.html');
            });
        } else {
            // No user is logged in, redirect them.
            sessionStorage.setItem('redirectUrl', window.location.href);
            window.location.href = '../authentication/login.html';
        }
    });

    function getStatusBadge(status) {
        switch (status) {
            case 'approved':
                return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">Approved</span>`;
            case 'rejected':
                return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-600 bg-red-200">Rejected</span>`;
            default:
                return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Pending</span>`;
        }
    }

    function loadApplications() {
        const applicationsList = document.getElementById('applications-list');
        const applicationsRef = db.collection('poortjie').doc('applications').collection('listings');

        applicationsRef.onSnapshot(snapshot => {
            if (snapshot.empty) {
                applicationsList.innerHTML = '<p>No applications found.</p>';
                return;
            }

            const applicationsByUser = {};
            snapshot.forEach(doc => {
                const app = doc.data();
                const userEmail = app.userEmail || 'Unknown User';
                if (!applicationsByUser[userEmail]) {
                    applicationsByUser[userEmail] = [];
                }
                applicationsByUser[userEmail].push({ id: doc.id, ...app });
            });

            let html = '';
            for (const userEmail in applicationsByUser) {
                html += `
                    <div class="user-group mb-6">
                        <h3 class="text-xl font-semibold mb-3 border-b pb-2">${userEmail}</h3>
                `;
                applicationsByUser[userEmail].forEach(app => {
                    const isPending = !app.status || app.status === 'pending';
                    html += `
                        <div class="p-4 border rounded-lg flex justify-between items-center mb-2">
                            <div>
                                <div class="flex items-center gap-x-3">
                                   <h4 class="font-bold">${app.businessName}</h4>
                                   ${getStatusBadge(app.status)}
                                </div>
                                <p class="text-sm">${app.ownerName} - ${app.phone}</p>
                                <p class="text-xs text-gray-500">${app.businessType}</p>
                            </div>
                            <div>
                                ${isPending ? `
                                <button onclick="approveApplication('${app.id}')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Approve</button>
                                <button onclick="rejectApplication('${app.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 ml-2">Reject</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            applicationsList.innerHTML = html;
        }, error => {
            console.error("Error loading applications:", error);
            applicationsList.innerHTML = '<p>Error loading applications. Check console for details.</p>';
        });
    }

    function approveApplication(appId) {
        const appRef = db.doc(`poortjie/applications/listings/${appId}`);
        const servicesRef = db.doc('poortjie/services');

        db.runTransaction(async (transaction) => {
            const appDoc = await transaction.get(appRef);
            if (!appDoc.exists) {
                throw "Application does not exist!";
            }
            
            const appData = appDoc.data();
            if (!appData.businessType) {
                throw "Application is missing a 'businessType' and cannot be approved.";
            }

            const businessData = { ...appData, status: 'active' };
            
            // Using dot notation to update a nested map. Firestore will create the nested objects if they don't exist.
            const updatePath = `homeScreen.${appData.businessType}.data.${appId}`;
            transaction.update(servicesRef, { [updatePath]: businessData });
            
            // Update the original application's status
            transaction.update(appRef, { status: 'approved' });

        }).then(() => {
            console.log("Application approved and business listing created!");
        }).catch(error => {
            console.error("Error approving application: ", error);
            alert("Error approving application: " + error);
        });
    }

    function rejectApplication(appId) {
        if (confirm('Are you sure you want to reject this application?')) {
            db.doc(`poortjie/applications/listings/${appId}`).update({ status: 'rejected' }).then(() => {
                console.log("Application rejected!");
            }).catch(error => {
                console.error("Error rejecting application: ", error);
            });
        }
    }
</script>

</body>
</html>
