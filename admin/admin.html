<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Poortjie Services</title>
    <meta name="robots" content="noindex, nofollow"> <!-- Prevents search engines from indexing this page -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" href="../favicon/favicon.ico">
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">

<div id="admin-content" class="hidden">
    <header class="max-w-6xl mx-auto pt-24 pb-16 px-6">
        <h1 class="text-4xl font-extrabold mb-4 tracking-tight">Admin Dashboard</h1>
        <p class="text-xl opacity-80">Welcome, Super User!</p>
    </header>

    <main class="max-w-6xl mx-auto px-6 pb-24">
        <div class="card p-8 rounded-2xl">
            <h2 class="text-2xl font-bold mb-6">Business Applications</h2>
            <div id="applications-list" class="space-y-4">
            </div>
        </div>

        <div class="card p-8 rounded-2xl mt-8">
            <h2 class="text-2xl font-bold mb-6">Taxi Management</h2>
            <div class="flex gap-4">
                <a href="taxi-routes.html" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md">Manage Taxi Routes</a>
            </div>
        </div>
    </main>
</div>

<script src="../scripts/theme.js"></script>
<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script src="../scripts/local-db.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>

<script>
    let currentCategories = [];

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            const userRef = db.collection('users').doc(user.uid);
            userRef.get().then((doc) => {
                if (doc.exists && doc.data().roles?.digilayn?.isSuperUser === true) {
                    document.getElementById('admin-content').classList.remove('hidden');
                    fetchCategories().then(() => {
                        loadApplications();
                    });
                } else {
                    window.top.location.replace('../index.html');
                }
            }).catch((error) => {
                console.error("Error getting user data:", error);
                alert('An error occurred while verifying your permissions.');
                window.top.location.replace('../index.html');
            });
        } else {
            sessionStorage.setItem('redirectUrl', window.top.location.href);
            window.top.location.replace('../authentication/login.html');
        }
    });

    async function fetchCategories() {
        try {
            const doc = await db.collection('poortjie').doc('services').get();
            if (doc.exists && doc.data().homeScreen) {
                currentCategories = Object.keys(doc.data().homeScreen).sort();
            }
        } catch (error) {
            console.error("Error fetching categories:", error);
        }
    }

    function getStatusBadge(status) {
        switch (status) {
            case 'approved':
                return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">Approved</span>`;
            case 'rejected':
                return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-600 bg-red-200">Rejected</span>`;
            case 'update':
                return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">Update Requested</span>`;
            default:
                return `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-yellow-600 bg-yellow-200">Pending</span>`;
        }
    }

    function loadApplications() {
        const applicationsList = document.getElementById('applications-list');
        const applicationsRef = db.collection('poortjie').doc('applications').collection('listings');

        applicationsRef.onSnapshot(snapshot => {
            if (snapshot.empty) {
                applicationsList.innerHTML = '<p>No applications found.</p>';
                return;
            }

            const applicationsByUser = {};
            snapshot.forEach(doc => {
                const app = doc.data();
                const userEmail = app.userEmail || 'Unknown User';
                if (!applicationsByUser[userEmail]) {
                    applicationsByUser[userEmail] = [];
                }
                applicationsByUser[userEmail].push({ id: doc.id, ...app });
            });

            let html = '';
            for (const userEmail in applicationsByUser) {
                html += `
                    <div class="user-group mb-6">
                        <h3 class="text-xl font-semibold mb-3 border-b pb-2">${userEmail}</h3>
                `;
                applicationsByUser[userEmail].forEach(app => {
                    const isPending = !app.status || app.status === 'pending' || app.status === 'update';
                    const isOther = app.businessType === 'Other';
                    
                    html += `
                        <div class="p-4 border rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center mb-2 gap-4">
                            <div class="flex-grow">
                                <div class="flex items-center gap-x-3">
                                   <h4 class="font-bold">${app.businessName}</h4>
                                   ${getStatusBadge(app.status)}
                                </div>
                                <p class="text-sm">${app.ownerName} - ${app.phone}</p>
                                <p class="text-xs text-gray-500">${app.businessType}</p>
                                
                                ${isPending && isOther ? `
                                <div class="mt-3 p-3 bg-gray-50 dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-slate-700">
                                    <p class="text-xs font-bold uppercase mb-2">Reassign Category</p>
                                    <div class="flex flex-col gap-2">
                                        <select id="category-select-${app.id}" class="text-sm p-2 rounded bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600">
                                            <option value="">-- Choose Existing --</option>
                                            ${currentCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                        </select>
                                        <input type="text" id="category-input-${app.id}" placeholder="Or type new category name" class="text-sm p-2 rounded bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600">
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="flex gap-2 shrink-0">
                                ${isPending ? `
                                <button onclick="approveApplication('${app.id}')" class="bg-green-500 text-white px-4 py-2 rounded font-bold hover:bg-green-600 transition shadow-sm">Approve</button>
                                <button onclick="requestUpdate('${app.id}')" class="bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-600 transition shadow-sm">Update</button>
                                <button onclick="rejectApplication('${app.id}')" class="bg-red-500 text-white px-4 py-2 rounded font-bold hover:bg-red-600 transition shadow-sm">Reject</button>
                                ` : `
                                <button onclick="approveApplication('${app.id}')" class="bg-gray-500 text-white px-4 py-2 rounded font-bold hover:bg-gray-600 transition shadow-sm">Re-Approve/Update</button>
                                <button onclick="requestUpdate('${app.id}')" class="bg-blue-500 text-white px-4 py-2 rounded font-bold hover:bg-blue-600 transition shadow-sm">Request Update</button>
                                `}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            applicationsList.innerHTML = html;
        }, error => {
            console.error("Error loading applications:", error);
            applicationsList.innerHTML = '<p>Error loading applications. Check console for details.</p>';
        });
    }

    async function approveApplication(appId) {
        const appRef = db.collection('poortjie').doc('applications').collection('listings').doc(appId);
        const servicesRef = db.collection('poortjie').doc('services');

        try {
            const appDoc = await appRef.get();
            if (!appDoc.exists) throw "Application does not exist!";
            const appData = appDoc.data();

            let finalCategory = appData.businessType;

            if (finalCategory === 'Other') {
                const selectVal = document.getElementById(`category-select-${appId}`).value;
                const inputVal = document.getElementById(`category-input-${appId}`).value.trim();
                
                finalCategory = inputVal || selectVal;
                
                if (!finalCategory || finalCategory === 'Other') {
                    alert("Please select or type a valid category for 'Other' business type.");
                    return;
                }
            }

            if (!confirm(`Approve this business under category "${finalCategory}"?`)) return;

            await db.runTransaction(async (transaction) => {
                const servicesDoc = await transaction.get(servicesRef);
                const servicesData = servicesDoc.data() || {};
                const homeScreen = servicesData.homeScreen || {};

                const businessData = { 
                    ...appData, 
                    businessType: finalCategory,
                    status: 'active',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const updateData = {};
                
                // If category doesn't exist, we need to initialize it
                if (!homeScreen[finalCategory]) {
                    updateData[`homeScreen.${finalCategory}`] = {
                        description: `Local ${finalCategory.toLowerCase()} services in Poortjie.`,
                        subtitle: `${finalCategory} Experts`,
                        listing: [],
                        data: { [appId]: businessData }
                    };
                } else {
                    updateData[`homeScreen.${finalCategory}.data.${appId}`] = businessData;
                }
                
                transaction.update(servicesRef, updateData);
                transaction.update(appRef, { 
                    status: 'approved',
                    businessType: finalCategory // Update the app record too
                });
            });

            console.log("Application approved!");
            // Refresh categories in case a new one was added
            await fetchCategories();
        } catch (error) {
            console.error("Error approving application: ", error);
            alert("Error: " + error);
        }
    }

    function rejectApplication(appId) {
        if (confirm('Are you sure you want to reject this application?')) {
            db.doc(`poortjie/applications/listings/${appId}`).update({ status: 'rejected' }).then(() => {
                console.log("Application rejected!");
            }).catch(error => {
                console.error("Error rejecting application: ", error);
            });
        }
    }

    function requestUpdate(appId) {
        if (confirm('Request user to update this application?')) {
            db.doc(`poortjie/applications/listings/${appId}`).update({ status: 'update' }).then(() => {
                console.log("Update requested!");
            }).catch(error => {
                console.error("Error requesting update: ", error);
            });
        }
    }
</script>

</body>
</html>
