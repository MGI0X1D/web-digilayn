<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Listing | Poortjie Services</title>
    <meta name="author" content="Musa Mgijima">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" href="../favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="../scripts/loader.js"></script>
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">


<header class="max-w-6xl mx-auto pt-24 pb-16 px-6 text-center text-gray-900 dark:text-gray-100">
    <a href="../index.html" onclick="window.location.replace('../index.html'); return false;" class="text-6xl font-extrabold mb-4 tracking-tight">Poortjie</a>
</header>

<main class="max-w-xl mx-auto px-6 pb-24">
    <div id="form-container" class="card hidden flex-col p-8 rounded-2xl border-l-4 border-l-green-500">
        <div id="applications-section" class="mb-12 hidden">
            <h2 class="text-2xl font-bold mb-6 text-center">My Applications</h2>
            <div id="user-applications-list" class="space-y-4"></div>
            <hr class="my-8 border-gray-200 dark:border-slate-700">
        </div>

        <h2 class="text-2xl font-bold mb-6 text-center">Business Listing</h2>
        <div id="status-container" class="hidden text-center mb-4 space-y-2"></div>
        <p class="text-center opacity-70 mb-8">Fill in the details below to list your business on Poortjie Services.</p>

        <form id="business-form" novalidate>
            <div class="form-group mb-4">
                <label for="owner-name" class="block mb-1 font-bold text-sm uppercase tracking-wider">Full Name</label>
                <div class="relative">
                    <input type="text" id="owner-name" name="owner_name" maxlength="50" placeholder="Enter your full name" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 cursor-not-allowed text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" readonly>
                    <p id="owner-name-error" class="absolute right-2 top-2 px-2 py-1 bg-red-500 text-white text-[10px] font-bold rounded shadow-sm hidden">Required</p>
                </div>
            </div>

            <div class="form-group mb-4">
                <label for="email" class="block mb-1 font-bold text-sm uppercase tracking-wider">Email</label>
                <div class="relative">
                    <input type="email" id="email" name="email" placeholder="Enter your email" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 cursor-not-allowed text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" readonly>
                    <p id="email-error" class="absolute right-2 top-2 px-2 py-1 bg-red-500 text-white text-[10px] font-bold rounded shadow-sm hidden">Invalid Email</p>
                </div>
            </div>

            <div class="form-group mb-4">
                <label for="phone" class="block mb-1 font-bold text-sm uppercase tracking-wider">Phone Number</label>
                <div class="relative">
                    <input type="tel" id="phone" name="phone" placeholder="e.g. 0721234567" maxlength="10" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                    <p id="phone-error" class="absolute right-2 top-2 px-2 py-1 bg-red-500 text-white text-[10px] font-bold rounded shadow-sm hidden">Invalid Phone</p>
                </div>
            </div>

            <div class="form-group mb-4">
                <label for="business-name" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business Name</label>
                <div class="relative">
                    <input type="text" id="business-name" name="business_name" maxlength="50" placeholder="What is your business called?" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                    <p id="business-name-error" class="absolute right-2 top-2 px-2 py-1 bg-red-500 text-white text-[10px] font-bold rounded shadow-sm hidden">Required</p>
                </div>
            </div>

            <div class="form-group mb-4">
                <label for="sub-heading" class="block mb-1 font-bold text-sm uppercase tracking-wider">Sub Heading</label>
                <input type="text" id="sub-heading" name="sub_heading" maxlength="100" placeholder="e.g. Your business tagline" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>

            <div class="form-group mb-4">
                <label for="business-type" class="block mb-1 font-bold text-sm uppercase tracking-wider">Type of Business</label>
                <div class="relative">
                    <select id="business-type" name="business_type" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                        <option value="" disabled selected>Select a category</option>
                    </select>
                    <p id="business-type-error" class="absolute right-8 top-2 px-2 py-1 bg-red-500 text-white text-[10px] font-bold rounded shadow-sm hidden">Required</p>
                </div>
            </div>

            <div class="form-group mb-4">
                <label for="address" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business Address</label>
                <div class="relative">
                    <input type="text" id="address" name="address" placeholder="Start typing your business address..." class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                    <button type="button" id="toggle-map-btn" class="absolute right-2 top-2 px-3 py-1 bg-green-600 text-white text-xs font-bold rounded hover:bg-green-700 transition">
                        <i class="fa-solid fa-map-location-dot mr-1"></i> Pick on Map
                    </button>
                    <p id="address-error" class="absolute right-2 top-2 px-2 py-1 bg-red-500 text-white text-[10px] font-bold rounded shadow-sm hidden">Must be in Poortjie</p>
                </div>
                <div id="map-container" class="mt-3 hidden">
                    <div id="map" class="w-full h-64 rounded-lg border-2 border-gray-200 dark:border-slate-700"></div>
                    <p class="text-[10px] mt-1 text-gray-500 italic">Drag the pin to your exact location (restricted to 5km radius)</p>
                </div>
            </div>

            <div class="form-group mb-4">
                <label class="block mb-1 font-bold text-sm uppercase tracking-wider">Social Links & Website</label>
                <button type="button" id="open-social-modal" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent hover:border-green-500 focus:outline-none transition flex items-center justify-between">
                    <span id="social-links-summary" class="opacity-70">Add WhatsApp, Facebook, Website</span>
                    <i class="fa-solid fa-share-nodes text-green-600"></i>
                </button>
                <input type="hidden" id="website" name="website">
                <input type="hidden" id="whatsapp" name="whatsapp">
                <input type="hidden" id="facebook" name="facebook">
            </div>

            <div id="social-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md overflow-hidden shadow-2xl border border-gray-100 dark:border-slate-800">
                    <div class="p-6 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center">
                        <h3 class="text-xl font-bold">Social Links</h3>
                        <button type="button" id="close-social-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white transition">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="form-group">
                            <label for="modal-whatsapp" class="block mb-1 font-bold text-xs uppercase tracking-wider opacity-70">WhatsApp Number</label>
                            <div class="relative">
                                <i class="fa-brands fa-whatsapp absolute left-3 top-3.5 text-green-500"></i>
                                <input type="tel" id="modal-whatsapp" placeholder="e.g. 0721234567" maxlength="10" class="w-full p-3 pl-10 rounded-lg bg-gray-100 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="modal-facebook" class="block mb-1 font-bold text-xs uppercase tracking-wider opacity-70">Facebook URL</label>
                            <div class="relative">
                                <i class="fa-brands fa-facebook absolute left-3 top-3.5 text-blue-600"></i>
                                <input type="url" id="modal-facebook" maxlength="200" placeholder="https://facebook.com/yourpage" class="w-full p-3 pl-10 rounded-lg bg-gray-100 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="modal-website" class="block mb-1 font-bold text-xs uppercase tracking-wider opacity-70">Website URL</label>
                            <div class="relative">
                                <i class="fa-solid fa-globe absolute left-3 top-3.5 text-gray-500"></i>
                                <input type="url" id="modal-website" maxlength="200" placeholder="https://yourwebsite.com" class="w-full p-3 pl-10 rounded-lg bg-gray-100 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
                            </div>
                        </div>
                    </div>
                    <div class="p-6 bg-gray-50 dark:bg-slate-800/50 flex gap-3">
                        <button type="button" id="save-social-links" class="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition">Save Links</button>
                    </div>
                </div>
            </div>

            <div class="form-group mb-4">
                <label for="hours" class="block mb-1 font-bold text-sm uppercase tracking-wider">Operating Hours</label>
                <input type="text" id="hours" name="hours" maxlength="100" placeholder="e.g. Mon-Fri 9am-5pm" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>

            <div class="form-group mb-6">
                <label for="description" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business Description</label>
                <div class="relative">
                    <textarea id="description" name="description" maxlength="200" placeholder="Tell us what your business is about..." class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" rows="4"></textarea>
                    <p id="description-error" class="absolute right-2 top-2 px-2 py-1 bg-red-500 text-white text-[10px] font-bold rounded shadow-sm hidden">Required</p>
                    <div id="description-counter" class="absolute right-2 bottom-2 text-[10px] opacity-40 font-mono">0/200</div>
                </div>
            </div>
        </form>

        <div id="preview-container" class="mt-12 pt-12 border-t border-gray-100 dark:border-slate-700 hidden">
            <h3 class="text-xl font-bold mb-6 text-center">Preview Your Listing</h3>
            <div id="card-preview" class="max-w-sm mx-auto">
            </div>
            <p class="text-xs text-center opacity-50 my-6 italic">Note: Rating and comments are for display purposes in this preview.</p>
            
            <button type="submit" form="business-form" id="submit-btn" class="w-full px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md opacity-50 cursor-not-allowed">Submit Business Details</button>
        </div>
    </div>
</main>

<footer class="text-center py-12 border-t border-gray-100 dark:border-slate-800 opacity-50 text-xs">
    &copy; 2026 Poortjie Services. Empowering poortjie economies.
</footer>

<script src="../scripts/theme.js"></script>

<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script src="../scripts/local-db.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>
<script src="../scripts/card-renderer.js"></script>

<script>
    const formContainer = document.getElementById('form-container');
    const businessForm = document.getElementById('business-form');
    const submitBtn = document.getElementById('submit-btn');
    const statusContainer = document.getElementById('status-container');

    const ownerNameInput = document.getElementById('owner-name');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const businessNameInput = document.getElementById('business-name');
    const subHeadingInput = document.getElementById('sub-heading');
    const businessTypeInput = document.getElementById('business-type');
    const addressInput = document.getElementById('address');
    const websiteInput = document.getElementById('website');
    const whatsappInput = document.getElementById('whatsapp');
    const facebookInput = document.getElementById('facebook');
    const hoursInput = document.getElementById('hours');
    const descInput = document.getElementById('description');
    const descCounter = document.getElementById('description-counter');
    const previewContainer = document.getElementById('preview-container');
    const cardPreview = document.getElementById('card-preview');
    const applicationsSection = document.getElementById('applications-section');
    const userApplicationsList = document.getElementById('user-applications-list');
    
    let currentEditingAppId = null;

    const mapContainer = document.getElementById('map-container');
    const toggleMapBtn = document.getElementById('toggle-map-btn');

    const socialModal = document.getElementById('social-modal');
    const openSocialModalBtn = document.getElementById('open-social-modal');
    const closeSocialModalBtn = document.getElementById('close-social-modal');
    const saveSocialLinksBtn = document.getElementById('save-social-links');
    const socialLinksSummary = document.getElementById('social-links-summary');

    const modalWhatsapp = document.getElementById('modal-whatsapp');
    const modalFacebook = document.getElementById('modal-facebook');
    const modalWebsite = document.getElementById('modal-website');
    let map, marker, geocoder;
    let selectedLat = null;
    let selectedLng = null;

    let isAddressSelectedFromAutocomplete = false;

    showLoader();

    const fetchCategories = () => {
        try {
            const cachedCategories = sessionStorage.getItem('categoriesCache');
            if (cachedCategories) {
                const categories = JSON.parse(cachedCategories);
                renderCategoryOptions(categories);
            }
        } catch (e) {
        }

        const servicesDocRef = db.collection('poortjie').doc('services');
        servicesDocRef.get().then(doc => {
            if (doc.exists) {
                const homeScreenData = doc.data().homeScreen;
                if (homeScreenData && typeof homeScreenData === 'object') {
                    const categories = Object.keys(homeScreenData);
                    
                    renderCategoryOptions(categories);
                    try {
                        sessionStorage.setItem('categoriesCache', JSON.stringify(categories));
                    } catch (e) {
                    }
                }
            }
        }).catch(error => {
        }).finally(() => {
            if (!Array.from(businessTypeInput.options).some(opt => opt.value === 'Other')) {
                const otherOption = document.createElement('option');
                otherOption.value = 'Other';
                otherOption.textContent = 'Other';
                businessTypeInput.appendChild(otherOption);
            }
        });
    };

    const renderCategoryOptions = (categories) => {
        while (businessTypeInput.options.length > 1) {
            businessTypeInput.remove(1);
        }
        
        const sortedCategories = [...categories].sort((a, b) => a.localeCompare(b));
        
        sortedCategories.forEach(categoryName => {
            const option = document.createElement('option');
            option.value = categoryName;
            option.textContent = categoryName;
            businessTypeInput.appendChild(option);
        });
    };

    const getStatusBadge = (status) => {
        switch (status) {
            case 'approved':
                return `<span class="text-[10px] font-bold py-1 px-2 uppercase rounded-full text-green-700 bg-green-100 border border-green-200">Approved</span>`;
            case 'rejected':
                return `<span class="text-[10px] font-bold py-1 px-2 uppercase rounded-full text-red-700 bg-red-100 border border-red-200">Rejected</span>`;
            case 'update':
                return `<span class="text-[10px] font-bold py-1 px-2 uppercase rounded-full text-blue-700 bg-blue-100 border border-blue-200">Update</span>`;
            default:
                return `<span class="text-[10px] font-bold py-1 px-2 uppercase rounded-full text-yellow-700 bg-yellow-100 border border-yellow-200">Pending</span>`;
        }
    };

    const renderUserApplications = (applications) => {
        if (!applications || applications.length === 0) {
            applicationsSection.classList.add('hidden');
            return;
        }

        applicationsSection.classList.remove('hidden');
        userApplicationsList.innerHTML = applications.map(app => {
            const canEdit = app.status === 'approved' || app.status === 'update';
            return `
                <div class="p-4 rounded-xl bg-gray-50 dark:bg-slate-800/50 border border-gray-100 dark:border-slate-700 flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-sm">${app.businessName}</h4>
                        <p class="text-xs opacity-60">${app.businessType}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        ${getStatusBadge(app.status)}
                        ${canEdit ? `
                            <button onclick="editApplication('${app.id}')" class="text-xs font-bold text-green-600 hover:text-green-700 dark:text-green-500 dark:hover:text-green-400 flex items-center gap-1">
                                <i class="fa-solid fa-pen-to-square"></i> Edit
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');

        window.editApplication = (appId) => {
            const app = applications.find(a => a.id === appId);
            if (!app) return;

            currentEditingAppId = appId;
            
            // Populate form
            ownerNameInput.value = app.ownerName || '';
            emailInput.value = app.email || '';
            phoneInput.value = app.phone || '';
            businessNameInput.value = app.businessName || '';
            subHeadingInput.value = app.subHeading || '';
            businessTypeInput.value = app.businessType || '';
            addressInput.value = app.address || '';
            websiteInput.value = app.website || '';
            whatsappInput.value = app.whatsapp || '';
            facebookInput.value = app.facebook || '';
            hoursInput.value = app.hours || '';
            descInput.value = app.description || '';
            
            selectedLat = app.latitude || null;
            selectedLng = app.longitude || null;
            isAddressSelectedFromAutocomplete = !!app.address;

            // Update social links summary
            const links = [];
            if (app.whatsapp) links.push('WhatsApp');
            if (app.facebook) links.push('Facebook');
            if (app.website) links.push('Website');
            if (links.length > 0) {
                socialLinksSummary.textContent = links.join(', ');
                socialLinksSummary.classList.remove('opacity-70');
                socialLinksSummary.classList.add('text-green-600', 'font-bold');
            } else {
                socialLinksSummary.textContent = 'Add WhatsApp, Facebook, Website';
                socialLinksSummary.classList.add('opacity-70');
                socialLinksSummary.classList.remove('text-green-600', 'font-bold');
            }

            // Update character counter
            const count = descInput.value.length;
            descCounter.textContent = `${count}/200`;

            // Unlock form fields
            businessForm.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id !== 'owner-name' && el.id !== 'email') {
                    el.disabled = false;
                }
            });
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            submitBtn.textContent = 'Update Business Details';

            // Update form description
            const formDescription = document.querySelector('#form-container p');
            if (formDescription) {
                formDescription.textContent = 'Update your business details below.';
                formDescription.classList.remove('text-yellow-600', 'dark:text-yellow-400', 'font-bold');
                formDescription.classList.add('opacity-70');
            }

            // Show form if it was hidden
            businessForm.classList.remove('hidden');
            statusContainer.classList.add('hidden');

            window.scrollTo({ top: businessForm.offsetTop - 100, behavior: 'smooth' });
            validateForm();
        };
    };

    const lockForm = (data) => {
        businessForm.querySelectorAll('input, textarea, select').forEach(el => el.disabled = true);
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        submitBtn.textContent = 'Application Pending';
        const formDescription = document.querySelector('#form-container p');
        if (formDescription) {
            if (data.status === 'update') {
                formDescription.textContent = 'An update has been requested for your application. Please click "Edit" below to make changes.';
                formDescription.classList.add('text-blue-600', 'dark:text-blue-400', 'font-bold');
            } else {
                formDescription.textContent = 'You have a pending application. Please wait for it to be reviewed before submitting another.';
                formDescription.classList.add('text-yellow-600', 'dark:text-yellow-400', 'font-bold');
            }
            formDescription.classList.remove('opacity-70');
        }
    };

    const validateForm = (showErrors = false) => {
        const isNameValid = ownerNameInput.value.trim().length > 0;
        const isEmailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim());
        const isPhoneValid = /^\d{10}$/.test(phoneInput.value.trim());
        const isBusinessNameValid = businessNameInput.value.trim().length > 0;
        const isBusinessTypeValid = businessTypeInput.value !== '';
        const isDescValid = descInput.value.trim().length > 0;
        
        const addressValue = addressInput.value.trim();
        let isAddressValid = true;
        if (addressValue.length > 0) {
            isAddressValid = isAddressSelectedFromAutocomplete && selectedLat !== null && selectedLng !== null;
        }

        const isValid = isNameValid && isEmailValid && isPhoneValid && isBusinessNameValid && isDescValid && isBusinessTypeValid && isAddressValid;
        
        if (isValid) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            submitBtn.disabled = false; // Keep it enabled to capture clicks
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        if (showErrors || isValid) {
            document.getElementById('owner-name-error').classList.toggle('hidden', isNameValid);
            document.getElementById('email-error').classList.toggle('hidden', isEmailValid);
            document.getElementById('phone-error').classList.toggle('hidden', isPhoneValid);
            document.getElementById('business-name-error').classList.toggle('hidden', isBusinessNameValid);
            document.getElementById('business-type-error').classList.toggle('hidden', isBusinessTypeValid);
            document.getElementById('description-error').classList.toggle('hidden', isDescValid);
            
            const addressError = document.getElementById('address-error');
            if (addressValue.length > 0 && !isAddressValid) {
                addressError.classList.remove('hidden');
            } else {
                addressError.classList.add('hidden');
            }
        }
        
        updatePreview();
        return isValid;
    };

    const updatePreview = async () => {
        const businessName = businessNameInput.value.trim();
        const description = descInput.value.trim();
        const phone = phoneInput.value.trim();
        const address = addressInput.value.trim() || 'Poortjie';
        const businessType = businessTypeInput.value;

        const website = websiteInput.value.trim();
        const whatsapp = whatsappInput.value.trim();
        const facebook = facebookInput.value.trim();

        if (businessName || description || phone) {
            previewContainer.classList.remove('hidden');
            
            const mockProvider = {
                id: 'preview',
                businessName: businessName || 'Business Name',
                subHeading: subHeadingInput.value.trim() || 'Your Tagline',
                description: description || 'Your business description will appear here...',
                phone: phone || '000 000 0000',
                address: address,
                latitude: selectedLat,
                longitude: selectedLng,
                website: website,
                whatsapp: whatsapp,
                facebook: facebook,
                rating: 5.0,
                ratings: {
                    'preview-user': {
                        rating: 5,
                        comment: 'This is a preview of how your customer comments will look.',
                        timestamp: { toMillis: () => Date.now() },
                        likes: { 'user1': true, 'user2': true }
                    }
                }
            };

            const card = await renderServiceCard(mockProvider, businessType || 'Category');
            if (card) {
                cardPreview.innerHTML = '';
                const rateBtn = card.querySelector('.rate-service');
                if (rateBtn) {
                    rateBtn.disabled = true;
                    rateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                cardPreview.appendChild(card);
            }
        } else {
            previewContainer.classList.add('hidden');
        }
    };

    [ownerNameInput, emailInput, phoneInput, businessNameInput, businessTypeInput, subHeadingInput, hoursInput, descInput].forEach(el => {
        el.addEventListener('input', () => {
            if (el === descInput) {
                const count = descInput.value.length;
                descCounter.textContent = `${count}/200`;
                descCounter.classList.toggle('text-red-500', count >= 200);
                descCounter.classList.toggle('opacity-40', count < 200);
            }
            validateForm(false);
        });
    });

    openSocialModalBtn.addEventListener('click', () => {
        socialModal.classList.remove('hidden');
        modalWhatsapp.value = whatsappInput.value;
        modalFacebook.value = facebookInput.value;
        modalWebsite.value = websiteInput.value;
    });

    closeSocialModalBtn.addEventListener('click', () => {
        socialModal.classList.add('hidden');
    });

    saveSocialLinksBtn.addEventListener('click', () => {
        whatsappInput.value = modalWhatsapp.value;
        facebookInput.value = modalFacebook.value;
        websiteInput.value = modalWebsite.value;

        const links = [];
        if (whatsappInput.value) links.push('WhatsApp');
        if (facebookInput.value) links.push('Facebook');
        if (websiteInput.value) links.push('Website');

        if (links.length > 0) {
            socialLinksSummary.textContent = links.join(', ');
            socialLinksSummary.classList.remove('opacity-70');
            socialLinksSummary.classList.add('text-green-600', 'font-bold');
        } else {
            socialLinksSummary.textContent = 'Add WhatsApp, Facebook, Website';
            socialLinksSummary.classList.add('opacity-70');
            socialLinksSummary.classList.remove('text-green-600', 'font-bold');
        }

        socialModal.classList.add('hidden');
        validateForm();
    });

    phoneInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
        validateForm(false);
    });
    
    addressInput.addEventListener('input', () => {
        isAddressSelectedFromAutocomplete = false;
        selectedLat = null;
        selectedLng = null;
        validateForm();
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            fetchCategories();
            const applicationsRef = db.collection('poortjie').doc('applications').collection('listings').where('userId', '==', user.uid).orderBy('createdAt', 'desc');
            applicationsRef.get().then(snapshot => {
                const applications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserApplications(applications);

                const pendingApplication = applications.find(app => app.status === 'pending' || app.status === 'update');
                if (pendingApplication) {
                    lockForm(pendingApplication);
                    
                    // Initial character count for description (even if locked)
                    const count = descInput.value.length;
                    descCounter.textContent = `${count}/200`;

                    hideLoader();
                    formContainer.classList.remove('hidden');
                    formContainer.classList.add('flex');
                } else {
                    const userDocRef = db.collection('users').doc(user.uid);
                    userDocRef.get().then((userDoc) => {
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            ownerNameInput.value = userData.displayName || user.displayName || '';
                            phoneInput.value = userData.phone || '';
                        } else {
                           ownerNameInput.value = user.displayName || '';
                        }
                        emailInput.value = user.email || '';
                    }).finally(() => {
                        hideLoader();
                        formContainer.classList.remove('hidden');
                        formContainer.classList.add('flex');
                        
                        // Initial character count for description
                        const count = descInput.value.length;
                        descCounter.textContent = `${count}/200`;
                        
                        validateForm();
                    });
                }
            }).catch(error => {
                 hideLoader();
                 formContainer.classList.remove('hidden');
                 formContainer.classList.add('flex');
            });
        } else {
            sessionStorage.setItem('redirectUrl', window.top.location.href);
            window.top.location.replace('../authentication/login.html');
        }
    });

    businessForm.addEventListener('submit', event => {
        event.preventDefault();
        
        if (!validateForm(true)) {
            return;
        }
        
        const originalBtnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="flex items-center justify-center gap-2">
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Submitting...
        </span>`;

        const user = auth.currentUser;
        if (!user) {
            window.top.location.replace('../authentication/login.html');
            return;
        }

        const businessData = {
            userId: user.uid,
            userEmail: user.email,
            ownerName: ownerNameInput.value,
            email: emailInput.value,
            phone: phoneInput.value,
            businessName: businessNameInput.value,
            subHeading: subHeadingInput.value,
            businessType: businessTypeInput.value,
            address: addressInput.value.trim() || null,
            latitude: addressInput.value.trim() ? selectedLat : null,
            longitude: addressInput.value.trim() ? selectedLng : null,
            website: websiteInput.value,
            whatsapp: whatsappInput.value,
            facebook: facebookInput.value,
            hours: hoursInput.value,
            description: descInput.value,
            status: 'pending',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (!currentEditingAppId) {
            businessData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        }

        const appPromise = currentEditingAppId 
            ? db.collection('poortjie').doc('applications').collection('listings').doc(currentEditingAppId).update(businessData)
            : db.collection('poortjie').doc('applications').collection('listings').add(businessData);

        appPromise.then(() => {
                const isUpdate = !!currentEditingAppId;
                currentEditingAppId = null; // Reset after successful submission
                statusContainer.innerHTML = `
                    <div class="p-4 rounded-lg bg-green-100 text-green-700 font-bold border border-green-200">
                        Success! Your business application has been ${isUpdate ? 'updated' : 'submitted'} and is now pending review.
                    </div>
                `;
                statusContainer.classList.remove('hidden');
                businessForm.classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                setTimeout(() => window.location.reload(), 3000);
            })
            .catch((error) => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                
                statusContainer.innerHTML = `
                    <div class="p-4 rounded-lg bg-red-100 text-red-700 font-bold border border-red-200">
                        Error: ${error.message || 'There was an error submitting your form. Please try again.'}
                    </div>
                `;
                statusContainer.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
    });

    toggleMapBtn.addEventListener('click', () => {
        mapContainer.classList.toggle('hidden');
        if (!mapContainer.classList.contains('hidden')) {
            if (!map) {
                initMap();
            } else {
                google.maps.event.trigger(map, 'resize');
            }
        }
    });

    function initMap() {
        const poortjieCenter = { lat: -26.456323807221267, lng: 27.77044633885547 };
        geocoder = new google.maps.Geocoder();

        map = new google.maps.Map(document.getElementById("map"), {
            center: poortjieCenter,
            zoom: 14,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            styles: [
                {
                    "featureType": "poi",
                    "stylers": [{ "visibility": "off" }]
                }
            ]
        });

        // Hide address error if user interacts with map
        google.maps.event.addListener(map, 'click', () => {
            document.getElementById('address-error').classList.add('hidden');
        });

        const circle = new google.maps.Circle({
            strokeColor: "#22c55e",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#22c55e",
            fillOpacity: 0.1,
            map: map,
            center: poortjieCenter,
            radius: 5000,
            clickable: false
        });

        marker = new google.maps.Marker({
            position: poortjieCenter,
            map: map,
            draggable: true,
            title: "Drag to your business location",
            animation: google.maps.Animation.DROP,
            icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
            }
        });

        marker.addListener("dragstart", () => {
             document.getElementById('address-error').classList.add('hidden');
        });

        marker.addListener("dragend", () => {
            const pos = marker.getPosition();
            const distance = google.maps.geometry.spherical.computeDistanceBetween(pos, poortjieCenter);

            if (distance > 5000) {
                const heading = google.maps.geometry.spherical.computeHeading(poortjieCenter, pos);
                const newPos = google.maps.geometry.spherical.computeOffset(poortjieCenter, 4990, heading);
                marker.setPosition(newPos);
                updateAddressFromPos(newPos);
            } else {
                updateAddressFromPos(pos);
            }
            updatePreview();
        });

        map.addListener("click", (e) => {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(e.latLng, poortjieCenter);
            if (distance <= 5000) {
                marker.setPosition(e.latLng);
                updateAddressFromPos(e.latLng);
                updatePreview();
            }
        });
    }

    function updateAddressFromPos(pos) {
        selectedLat = pos.lat();
        selectedLng = pos.lng();
        
        // Only set address to "Dropped Pin" if it's currently empty
        if (!addressInput.value.trim()) {
            addressInput.value = "Dropped Pin";
            isAddressSelectedFromAutocomplete = true;
            validateForm();
        }
    }

    function initAutocomplete() {
        const poortjieCenter = { lat: -26.456323807221267, lng: 27.77044633885547 };

        const circle = new google.maps.Circle({
            center: poortjieCenter,
            radius: 5000 
        });

        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
            bounds: circle.getBounds(),
            strictBounds: true, 
            componentRestrictions: { country: "za" },
            fields: ["formatted_address", "geometry"],
            types: ["address"],
        });

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (place.formatted_address) {
                addressInput.value = place.formatted_address;
                isAddressSelectedFromAutocomplete = true;
                
                if (place.geometry && place.geometry.location) {
                    selectedLat = place.geometry.location.lat();
                    selectedLng = place.geometry.location.lng();
                    
                    if (map && marker) {
                        marker.setPosition(place.geometry.location);
                        map.setCenter(place.geometry.location);
                    }
                    updatePreview();
                }
                
                validateForm();
            }
        });
    }
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXnSxBam3mjlfEx3F4XL_7ZIwLEbov0n8&loading=async&libraries=places,geometry&callback=initAutocomplete"></script>
</body>
</html>
