<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Listing | Digilayn</title>
    <meta name="author" content="Musa Mgijima">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" href="../favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <script src="../scripts/loader.js"></script>
</head>
<body class="font-sans antialiased bg-gray-50 dark:bg-slate-900">

<div class="fixed top-5 right-5 z-50 flex gap-2">
    <button id="theme-toggle" class="px-4 py-2 rounded-full bg-green-600 text-white shadow-lg hover:bg-green-700 transition flex items-center gap-2">
        <span id="theme-icon">ðŸŒ“</span> <span class="text-xs font-bold uppercase tracking-widest text-[10px]">Mode</span>
    </button>
</div>

<header class="max-w-6xl mx-auto pt-24 pb-16 px-6 text-center text-gray-900 dark:text-gray-100">
    <a href="../index.html" class="text-6xl font-extrabold mb-4 tracking-tight">digilayn</a>
</header>

<main class="max-w-xl mx-auto px-6 pb-24">
    <div id="form-container" class="card flex flex-col p-8 rounded-2xl border-l-4 border-l-green-500" style="display: none;">
        <h2 class="text-2xl font-bold mb-6 text-center">Business Listing</h2>
        <div id="status-container" class="hidden text-center mb-4 space-y-2"></div>
        <p class="text-center opacity-70 mb-8">Fill in the details below to list your business on Digilayn.</p>

        <form id="business-form">
            <div class="form-group mb-4">
                <label for="owner-name" class="block mb-1 font-bold text-sm uppercase tracking-wider">Full Name</label>
                <input type="text" id="owner-name" name="owner_name" placeholder="Enter your full name" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 cursor-not-allowed text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" readonly>
            </div>

            <div class="form-group mb-4">
                <label for="email" class="block mb-1 font-bold text-sm uppercase tracking-wider">Email</label>
                <input type="email" id="email" name="email" placeholder="Enter your email" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 cursor-not-allowed text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" readonly>
            </div>

            <div class="form-group mb-4">
                <label for="phone" class="block mb-1 font-bold text-sm uppercase tracking-wider">Phone Number</label>
                <input type="tel" id="phone" name="phone" placeholder="e.g. 0721234567" maxlength="10" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" required>
            </div>

            <div class="form-group mb-4">
                <label for="business-name" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business Name</label>
                <input type="text" id="business-name" name="business_name" maxlength="50" placeholder="What is your business called?" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" required>
            </div>

            <div class="form-group mb-4">
                <label for="sub-heading" class="block mb-1 font-bold text-sm uppercase tracking-wider">Sub Heading</label>
                <input type="text" id="sub-heading" name="sub_heading" maxlength="100" placeholder="e.g. Your business tagline" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>

            <div class="form-group mb-4">
                <label for="business-type" class="block mb-1 font-bold text-sm uppercase tracking-wider">Type of Business</label>
                <select id="business-type" name="business_type" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" required>
                    <option value="" disabled selected>Select a category</option>
                </select>
            </div>

            <div class="form-group mb-4">
                <label for="address" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business Address</label>
                <input type="text" id="address" name="address" placeholder="Start typing your business address..." class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>

            <div class="form-group mb-4">
                <label for="website" class="block mb-1 font-bold text-sm uppercase tracking-wider">Website or Social Media</label>
                <input type="url" id="website" name="website" placeholder="https://example.com" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>

            <div class="form-group mb-4">
                <label for="hours" class="block mb-1 font-bold text-sm uppercase tracking-wider">Operating Hours</label>
                <input type="text" id="hours" name="hours" placeholder="e.g. Mon-Fri 9am-5pm" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>

            <div class="form-group mb-6">
                <label for="description" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business Description</label>
                <textarea id="description" name="description" placeholder="Tell us what your business is about..." class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" rows="4" required></textarea>
            </div>

            <button type="submit" id="submit-btn" disabled class="w-full px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Submit Business Details</button>
        </form>
    </div>
</main>

<footer class="text-center py-12 border-t border-gray-100 dark:border-slate-800 opacity-50 text-xs">
    &copy; 2026 Digilayn. Empowering poortjie economies.
</footer>

<script src="../scripts/theme.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>

<script>
    const formContainer = document.getElementById('form-container');
    const businessForm = document.getElementById('business-form');
    const submitBtn = document.getElementById('submit-btn');
    const statusContainer = document.getElementById('status-container');

    const ownerNameInput = document.getElementById('owner-name');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const businessNameInput = document.getElementById('business-name');
    const subHeadingInput = document.getElementById('sub-heading');
    const businessTypeInput = document.getElementById('business-type');
    const addressInput = document.getElementById('address');
    const websiteInput = document.getElementById('website');
    const hoursInput = document.getElementById('hours');
    const descInput = document.getElementById('description');

    let isAddressSelectedFromAutocomplete = false;

    showLoader();

    const fetchCategories = () => {
        const servicesDocRef = db.collection('poortjie').doc('services');
        servicesDocRef.get().then(doc => {
            if (doc.exists) {
                const homeScreenData = doc.data().homeScreen;
                if (homeScreenData && typeof homeScreenData === 'object') {
                    const categories = Object.keys(homeScreenData);
                    categories.forEach(categoryName => {
                        const option = document.createElement('option');
                        option.value = categoryName;
                        option.textContent = categoryName;
                        businessTypeInput.appendChild(option);
                    });
                }
            }
        }).catch(error => {
            console.error("Error fetching categories: ", error);
        }).finally(() => {
            const otherOption = document.createElement('option');
            otherOption.value = 'Other';
            otherOption.textContent = 'Other';
            businessTypeInput.appendChild(otherOption);
        });
    };

    const lockForm = (data) => {
        businessForm.querySelectorAll('input, textarea, select').forEach(el => el.disabled = true);
        submitBtn.disabled = true;
        submitBtn.textContent = 'Application Pending';
        const formDescription = document.querySelector('#form-container p');
        if (formDescription) {
            formDescription.textContent = 'You have a pending application. Please wait for it to be reviewed before submitting another.';
            formDescription.classList.add('text-yellow-600', 'dark:text-yellow-400', 'font-bold');
            formDescription.classList.remove('opacity-70');
        }
    };

    const validateForm = () => {
        const isNameValid = ownerNameInput.value.trim().length > 0;
        const isEmailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim());
        const isPhoneValid = /^\d{10}$/.test(phoneInput.value.trim());
        const isBusinessNameValid = businessNameInput.value.trim().length > 0;
        const isBusinessTypeValid = businessTypeInput.value !== '';
        const isDescValid = descInput.value.trim().length > 0;
        const isAddressValid = isAddressSelectedFromAutocomplete || addressInput.value.trim() === '';

        submitBtn.disabled = !(isNameValid && isEmailValid && isPhoneValid && isBusinessNameValid && isDescValid && isBusinessTypeValid && isAddressValid);
    };

    [businessNameInput, businessTypeInput, subHeadingInput, websiteInput, hoursInput, descInput].forEach(el => {
        el.addEventListener('input', validateForm);
    });

    phoneInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
        validateForm();
    });
    
    addressInput.addEventListener('input', () => {
        isAddressSelectedFromAutocomplete = false;
        validateForm();
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            fetchCategories();
            const applicationsRef = db.collection('poortjie').doc('applications').collection('listings').where('userId', '==', user.uid).orderBy('createdAt', 'desc');
            applicationsRef.get().then(snapshot => {
                const pendingApplication = snapshot.docs.find(doc => doc.data().status === 'pending');
                if (pendingApplication) {
                    lockForm(pendingApplication.data());
                } else {
                    const userDocRef = db.collection('users').doc(user.uid);
                    userDocRef.get().then((userDoc) => {
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            ownerNameInput.value = userData.displayName || user.displayName || '';
                            phoneInput.value = userData.phone || '';
                        } else {
                           ownerNameInput.value = user.displayName || '';
                        }
                        emailInput.value = user.email || '';
                    }).finally(() => {
                        hideLoader();
                        formContainer.style.display = 'block';
                        validateForm();
                    });
                }
            }).catch(error => {
                 console.error("Error checking for applications: ", error);
                 hideLoader();
                 formContainer.style.display = 'block';
            });
        } else {
            sessionStorage.setItem('redirectUrl', window.location.href);
            window.location.href = '../authentication/login.html';
        }
    });

    businessForm.addEventListener('submit', event => {
        event.preventDefault();
        if (submitBtn.disabled) return;
        showLoader();
        const user = auth.currentUser;
        if (!user) {
            window.location.href = '../authentication/login.html';
            return;
        }

        const businessData = {
            userId: user.uid,
            userEmail: user.email,
            ownerName: ownerNameInput.value,
            email: emailInput.value,
            phone: phoneInput.value,
            businessName: businessNameInput.value,
            subHeading: subHeadingInput.value,
            businessType: businessTypeInput.value,
            address: addressInput.value || null,
            website: websiteInput.value,
            hours: hoursInput.value,
            description: descInput.value,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        db.collection('poortjie').doc('applications').collection('listings').add(businessData)
            .then(() => {
                alert('Thank you! Your business has been submitted successfully.');
                window.location.reload();
            })
            .catch((error) => {
                hideLoader();
                console.error("Error adding document: ", error);
                alert('There was an error submitting your form.');
            });
    });

    /**
     * UPDATED AUTOCOMPLETE FUNCTION
     * Fixed to strictly 5km from Poortjie Center
     */
    function initAutocomplete() {
        // Poortjie Center Coordinates provided
        const poortjieCenter = { lat: -26.456323807221267, lng: 27.77044633885547 };

        // Define a 5km circle
        const circle = new google.maps.Circle({
            center: poortjieCenter,
            radius: 5000 // 5km in meters
        });

        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
            bounds: circle.getBounds(),
            strictBounds: true, // This is crucial: it restricts results to the bounds only
            componentRestrictions: { country: "za" },
            fields: ["formatted_address", "geometry"],
            types: ["address"],
        });

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (place.formatted_address) {
                addressInput.value = place.formatted_address;
                isAddressSelectedFromAutocomplete = true;
                validateForm();
            }
        });
    }
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXnSxBam3mjlfEx3F4XL_7ZIwLEbov0n8&loading=async&libraries=places,geometry&callback=initAutocomplete"></script>

</body>
</html>
