<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Registration | Digilayn</title>
    <meta name="author" content="Musa Mgijima">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" href="../favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <script src="../scripts/loader.js"></script>
</head>
<body class="font-sans antialiased bg-gray-50 dark:bg-slate-900">

<div class="fixed top-5 right-5 z-50 flex gap-2">
    <button id="theme-toggle" class="px-4 py-2 rounded-full bg-green-600 text-white shadow-lg hover:bg-green-700 transition flex items-center gap-2">
        <span id="theme-icon">ðŸŒ“</span> <span class="text-xs font-bold uppercase tracking-widest text-[10px]">Mode</span>
    </button>
</div>

<header class="max-w-6xl mx-auto pt-24 pb-16 px-6 text-center text-gray-900 dark:text-gray-100">
    <a href="../index.html" class="text-6xl font-extrabold mb-4 tracking-tight">digilayn</a>
</header>

<main class="max-w-xl mx-auto px-6 pb-24">
    <div id="form-container" class="card flex flex-col p-8 rounded-2xl border-l-4 border-l-green-500" style="display: none;">
        <h2 class="text-2xl font-bold mb-6 text-center">Business Registration</h2>
        <p class="text-center opacity-70 mb-8">Fill in the details below to list your business on Digilayn.</p>
        
        <form id="business-form">
            <div class="form-group mb-4">
                <label for="owner-name" class="block mb-1 font-bold text-sm uppercase tracking-wider">Full Name</label>
                <input type="text" id="owner-name" name="owner_name" placeholder="Enter your full name" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" required>
            </div>

            <div class="form-group mb-4">
                <label for="phone" class="block mb-1 font-bold text-sm uppercase tracking-wider">Phone Number</label>
                <input type="tel" id="phone" name="phone" placeholder="e.g. 072 123 4567" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" required>
            </div>

            <div class="form-group mb-4">
                <label for="business-name" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business Name</label>
                <input type="text" id="business-name" name="business_name" placeholder="What is your business called?" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" required>
            </div>

            <div class="form-group mb-4">
                <label for="address" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business Address</label>
                <input type="text" id="address" name="address" placeholder="Street, Area, Town" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" required>
            </div>

            <div class="form-group mb-6">
                <label for="description" class="block mb-1 font-bold text-sm uppercase tracking-wider">Business Description</label>
                <textarea id="description" name="description" placeholder="Tell us what your business is about..." class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" rows="4" required></textarea>
            </div>

            <button type="submit" class="w-full px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md">Submit Business Details</button>
        </form>
    </div>
</main>

<footer class="text-center py-12 border-t border-gray-100 dark:border-slate-800 opacity-50 text-xs">
    &copy; 2026 Digilayn. Empowering poortjie economies.
</footer>

<script src="../scripts/theme.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>

<script>
    const formContainer = document.getElementById('form-container');

    showLoader(); // Show loader on page load

    auth.onAuthStateChanged(user => {
        if (user) {
            // User is logged in, fetch data and show the form
            const ownerNameInput = document.getElementById('owner-name');
            const phoneInput = document.getElementById('phone');

            const userDocRef = db.collection('users').doc(user.uid);

            userDocRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.displayName) {
                        ownerNameInput.value = userData.displayName;
                    }
                    if (userData.phone) {
                        phoneInput.value = userData.phone;
                    }
                } else {
                    // Fallback to auth display name if firestore doc doesn't exist
                    if(user.displayName) {
                        ownerNameInput.value = user.displayName;
                    }
                }
            }).catch((error) => {
                console.log("Error getting document:", error);
                // Fallback to auth display name on error
                if(user.displayName) {
                    ownerNameInput.value = user.displayName;
                }
            }).finally(() => {
                hideLoader();
                formContainer.style.display = 'block';
            });
        } else {
            // User is not logged in, save the current URL and redirect
            sessionStorage.setItem('redirectUrl', window.location.href);
            window.location.href = '../authentication/login.html';
        }
    });

    const businessForm = document.getElementById('business-form');
    businessForm.addEventListener('submit', event => {
        event.preventDefault();
        showLoader(); // Show loader on form submission

        const user = auth.currentUser;
        if (!user) {
            hideLoader();
            alert('You must be logged in to submit this form.');
            return;
        }

        const businessData = {
            ownerId: user.uid,
            ownerName: businessForm.owner_name.value,
            phone: businessForm.phone.value,
            businessName: businessForm.business_name.value,
            address: businessForm.address.value,
            description: businessForm.description.value,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection('businesses').add(businessData)
            .then((docRef) => {
                hideLoader();
                alert('Thank you! Your business has been submitted successfully.');
                businessForm.reset();
            })
            .catch((error) => {
                hideLoader();
                console.error("Error adding document: ", error);
                alert('There was an error submitting your form. Please try again.');
            });
    });
</script>

</body>
</html>
